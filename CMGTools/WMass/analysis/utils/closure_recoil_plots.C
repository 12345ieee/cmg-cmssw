#include "TFile.h"
#include "TH1.h"
#include "TCanvas.h"
#include "TLine.h"
#include "TString.h"
#include <iostream>

using namespace std;

void syst_recoil_one(TString recstr="u2")
{
  const int nhists = 6;

  int IniVar[nhists] = {0,  9,  0, 0,  9,  0 };
  int NVar[nhists]   = {9, 18, 12, 9, 18, 12 };

  TFile* fcentral = new TFile(Form("0.root"));
  TH1D* hcentral=(TH1D*)fcentral->Get(Form("hWlikePos_%s_8_JetCut_pdf229800-0_eta0p9_91188", recstr.Data()));

  TFile* fmadgraph = new TFile(Form("madnocorr.root"));
  TH1D* hmadgraph = (TH1D*)fmadgraph->Get(Form("hWlikePos_%s_8_JetCut_pdf229800-0_eta0p9_91188", recstr.Data()));
  hmadgraph->SetTitle("Madgraph");
  hmadgraph->SetName("madgraph");

  TH1D* hcentral_noerr = (TH1D*)hcentral->Clone("hcentral_noerr");
  for(int i=1;i<hcentral_noerr->GetNbinsX()+1; i++){
    //hcentral_noerr->SetBinError(i, 0);
  }
  hcentral_noerr ->Scale(1/hcentral->Integral());

  hcentral ->Scale(1/hcentral->Integral());
  hcentral ->Divide(hcentral_noerr);

  hmadgraph->Scale(1/hmadgraph->Integral());
  hmadgraph->Divide(hcentral_noerr);


  TCanvas* c=new TCanvas("c_"+recstr, "c_"+recstr);
  c->cd();

  hcentral->Draw();

  TFile* fin[nhists];
  TH1D* hsyst[60];

  int nsyst=0;
  for(int i=0; i<6; i++){
    fin[i]=new TFile(Form("%d.root", i+1));
    for(int j=IniVar[i]; j<NVar[i]; j++){
      hsyst[nsyst]=(TH1D*)fin[i]->Get(Form("hWlikePos_%s_8_JetCut_pdf229800-0_RecoilCorrVar%d_eta0p9_91188", recstr.Data(), j));
      hsyst[nsyst]->SetName(Form("hWlikePos_%s_8_JetCut_pdf229800-0_RecoilCorrVar%d_eta0p9_91188", recstr.Data(), nsyst));
      hsyst[nsyst]->SetTitle(Form("hWlikePos_%s_8_JetCut_pdf229800-0_RecoilCorrVar%d_eta0p9_91188", recstr.Data(), nsyst));
      hsyst[nsyst]->Scale(1/hsyst[nsyst]->Integral());
      hsyst[nsyst]->Divide(hcentral_noerr);
      hsyst[nsyst]->SetLineColor(nsyst);
      hsyst[nsyst]->SetMarkerStyle(20);
      hsyst[nsyst]->SetMarkerSize(0.01);
      hsyst[nsyst]->SetMarkerColor(nsyst);
      hsyst[nsyst]->Draw("same");
      nsyst++;
    }
  }

  TH1D* hclosure = (TH1D*)hcentral->Clone("hclosure");
  hclosure->SetName("hclosure");
  hclosure->SetTitle("hclosure");
  for(int i=1;i<hclosure->GetNbinsX()+1; i++){
    double error = hclosure->GetBinError(i);
    for(int j=0; j<60; j++){
      error = sqrt(error*error+(hsyst[j]->GetBinContent(i)-1)*(hsyst[j]->GetBinContent(i)-1));
    }
    hclosure->SetBinError(i, error);
  }

  TCanvas *c_closure = new TCanvas("c_closure_"+recstr, "c_closure_"+recstr);
  c_closure->cd();
  hclosure->SetFillColor(2);
  hclosure->SetFillStyle(3002);
  hclosure->GetYaxis()->SetRangeUser(0,2);
  hclosure->Draw("E4");

  TLine *line = new TLine(-20,1,20,1);
  line->Draw("same");

  hmadgraph->SetLineWidth(2);
  hmadgraph->SetLineColor(4);
  hmadgraph->Draw("histo same e");


  TH1D* hsigmas = (TH1D*)hmadgraph->Clone("hsigmas");
  hsigmas->SetName("hsigmas");
  hsigmas->SetTitle("hsigmas");

  TH1D* hpull = new TH1D("hpull", "hpull", 50, -4, 4);

  for(int i=1; i<hsigmas->GetNbinsX()+1; i++){
    double ratio = (hmadgraph->GetBinContent(i)-1)/hclosure->GetBinError(i);
    hsigmas->SetBinContent(i, ratio);
    hpull->Fill(ratio);
  }

  TCanvas *c_sigmas = new TCanvas("c_sigmas_"+recstr, "c_sigmas_"+recstr);
  c_sigmas->cd();

  hsigmas->Draw("histo");


  TCanvas *c_pull = new TCanvas("c_pull_"+recstr, "c_pull_"+recstr);
  c_pull->cd();

  hpull->Draw("histo");


  TFile* fout = new TFile(recstr+".root", "RECREATE");
  fout->cd();
  c->Write();
  c_closure->Write();
  c_sigmas->Write();
  c_pull->Write();
}

int closure_recoil_plots()
{
  // syst_recoil_one("u1");
  syst_recoil_one("u2");
  return 0;
}

int main()
{
  closure_recoil_plots();
  return 0;
}
