#!/usr/bin/env perl

use strict "vars";
use vars qw( %opts );
use vars qw( %config );

use Getopt::Long;

Getopt::Long::config('bundling_override');
%opts = ();
GetOptions( \%opts,
                "run|r=s",
                "file|f=s",
                "help|h"
);
usage() if ( $opts{'help'} || $Getopt::Long::error );

my $runnum = $opts{'run'};
my $filnam = $opts{'file'};

usage() if ( ! $runnum && ! $filnam );

use File::Basename;

unshift(@INC, dirname($0));
require "ec_mon_utils.pl";

ec_mon_conf_file();

my ($loc, $num, $lun, $out, $fun, $fil, $ful) = split('\.', $runnum);

if ( $runnum ) {
  exit 0 unless ( -e "$config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.PEDESTAL-OFFSET_SCAN.daq_done" ||
                  -e "$config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.PEDESTAL-OFFSET_SCAN.mon_run" ||
                  -e "$config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.PEDESTAL-OFFSET_SCAN.mon_done" ||
                  -e "$config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.PEDESTAL-OFFSET_SCAN.mon_fail" );
}

my @filelist = split('\n', `find $config{'ec_mon_master_rundir'}/daq-data/ -maxdepth 1 \\( -name 'ecal_local.$num.*.A.$fun.*.*.dat' -or -name 'Global*.$num.*.A.$fun.*.*.dat' -or -name 'MW*.$num.*.A.$fun.*.*.dat' -or -name 'PrivCal*.$num.*.A.$fun.*.*.dat' -or -name 'TransferTestWithSafety.$num.*.A.$fun.*.*.dat' -or -name 'CRUZET*.$num.*.A.$fun.*.*.dat' -or -name 'CRAFT*.$num.*.A.$fun.*.*.dat' -or -name 'Commissioning*.$num.*.A.$fun.*.*.dat' -or -name 'Run*.$num.*.A.$fun.*.*.dat' -or -name 'Data.$num.*.A.$fun.*.*.dat' -or -name 'Minidaq.$num.*.A.$fun.*.*.dat' -or -name 'PrivMinidaq.$num.*.A.$fun.*.*.dat' \\) -printf '%f\n' 2>&1 | sort`);

my @filelist_archived = split('\n', `find $config{'ec_mon_master_rundir'}/daq-data/trash/ -maxdepth 1 \\( -name 'ecal_local.$num.*.A.$fun.*.*.dat' -or -name 'Global*.$num.*.A.$fun.*.*.dat' -or -name 'MW*.$num.*.A.$fun.*.*.dat' -or -name 'PrivCal*.$num.*.A.$fun.*.*.dat' -or -name 'TransferTestWithSafety.$num.*.A.$fun.*.*.dat' -or -name 'CRUZET*.$num.*.A.$fun.*.*.dat' -or -name 'CRAFT*.$num.*.A.$fun.*.*.dat' -or -name 'Commissioning*.$num.*.A.$fun.*.*.dat' -or -name 'Run*.$num.*.A.$fun.*.*.dat' -or -name 'Data.$num.*.A.$fun.*.*.dat' -or -name 'Minidaq.$num.*.A.$fun.*.*.dat' -or -name 'PrivMinidaq.$num.*.A.$fun.*.*.dat' \\) -printf '%f\n' 2>&1 | sort`);

if ( $runnum ) {
  exit 1 unless ( @filelist != 0 ||
                  @filelist_archived != 0 );
}

if ( $filnam ) {
  if ( -e "$filnam" ) {
    $runnum = basename($filnam);
  } else {
    print "file: $filnam does not exist ...\n";
    exit 1;
  }
}

my $cmssw_arch = "slc5_ia32_gcc434";
my $cmssw_setup = "/nfshome0/cmssw/scripts/setup.sh";
my $cmssw_path = "/nfshome0/ecalpro/DQM/CMSSW_3_9_1";

#my $cmssw_arch = "slc5_amd64_gcc434";
#my $cmssw_setup = "/nfshome0/cmssw2/scripts/setup.sh";
#my $cmssw_path = "/nfshome0/ecalpro/DQM/CMSSW_3_11_0";

if ( $config{'ec_mon_path'} =~ /localDAQ/ ) {
  $cmssw_arch = "slc4_ia32_gcc345";
  $cmssw_setup = "/nfshome0/cmssw/scripts/setup.sh";
  $cmssw_path = "/nfshome0/ecalpro/DQM/CMSSW_3_3_5";
}

if ( @filelist != 0 && $filelist[0] =~ /^Minidaq/ ) {
  $cmssw_arch = "slc5_ia32_gcc434";
  $cmssw_setup = "/nfshome0/cmssw/scripts/setup.sh";
  $cmssw_path = "/nfshome0/ecalpro/DQM/CMSSW_3_8_2";
}

my $xml_path = "/nfshome0/ecalpro/XML-DQM";

exit 1 unless ( -e "$cmssw_path" );

my $task;

if ( -e "$config{'ec_mon_master_rundir'}/dqm-data/tmp/pedestal-offset-$runnum.py" ) {
  system("rm -f $config{'ec_mon_master_rundir'}/dqm-data/tmp/pedestal-offset-$runnum.py >> /dev/null 2>&1");
}

open CONFIGFILE, ">>$config{'ec_mon_master_rundir'}/dqm-data/tmp/pedestal-offset-$runnum.py";

print CONFIGFILE <<EOF1;
import FWCore.ParameterSet.Config as cms

import os
os.environ['TNS_ADMIN']='/etc'

dbName = ''
dbHostName = ''
dbHostPort = 1521
dbUserName = ''
dbPassword = ''

try:
  file = open('$config{'ec_mon_path'}/.cms_tstore.conf', 'r')
  for line in file:
    if line.find('dbName') >= 0:
      dbName = line.split()[2]
    if line.find('dbHostName') >= 0:
      dbHostName = line.split()[2]
    if line.find('dbHostPort') >= 0:
      dbHostPort = int(line.split()[2])
    if line.find('dbUserName') >= 0:
      dbUserName = line.split()[2]
    if line.find('dbPassword') >= 0:
      dbPassword = line.split()[2]
  file.close()
except IOError:
  pass

process = cms.Process("ECALDQM")

process.load("EventFilter.EcalRawToDigi.EcalUnpackerMapping_cfi")

process.load("EventFilter.EcalRawToDigi.EcalUnpackerData_cfi")

process.load("Geometry.EcalMapping.EcalMapping_cfi")

process.load("Geometry.EcalMapping.EcalMappingRecord_cfi")

process.load("CalibCalorimetry.EcalTrivialCondModules.EcalTrivialCondRetriever_cfi")

process.ecalPedOffset = cms.EDAnalyzer("EcalPedOffset",
    EBdigiCollection = cms.InputTag("ecalEBunpacker","ebDigis"),
    EEdigiCollection = cms.InputTag("ecalEBunpacker","eeDigis"),
    headerCollection = cms.InputTag("ecalEBunpacker"),

    DACmin = cms.untracked.int32(40),
    DACmax = cms.untracked.int32(90),
    RMSmax = cms.untracked.double(20.0),

    bestPed = cms.untracked.int32(200),
    minSlopeAllowed = cms.untracked.double(-18.0),
    maxSlopeAllowed = cms.untracked.double(-29.0),
    maxChi2OverNDF = cms.untracked.double(5.25),

    dbName = cms.untracked.string(dbName),
    dbHostName = cms.untracked.string(dbHostName),
    dbHostPort = cms.untracked.int32(dbHostPort),
    dbUserName = cms.untracked.string(dbUserName),
    dbPassword = cms.untracked.string(dbPassword),

    createMonIOV = cms.untracked.bool(False),
    location = cms.untracked.string('P5_Co'),

EOF1

printf CONFIGFILE "    run = cms.int32(%d),\n", $num;

printf CONFIGFILE "    xmlFile = cms.string('pedestal-offset-%s'),\n", $runnum;
printf CONFIGFILE "    plotting = cms.string('pedestal-offset-%s')\n", $runnum;

print CONFIGFILE <<EOF2;
)

process.printAscii = cms.OutputModule("AsciiOutputModule",
    prescale = cms.untracked.uint32(10)
)

process.source = cms.Source("NewEventStreamFileReader",
EOF2

if ( $filnam ) {
  printf CONFIGFILE "    fileNames = cms.untracked.vstring('file:$filnam')\n";
} elsif ( @filelist != 0 ) {
  my $i=0;
  printf CONFIGFILE "    fileNames = cms.untracked.vstring(";
  printf CONFIGFILE "'file:$config{'ec_mon_master_rundir'}/daq-data/$filelist[$i]'";
  for ($i=1; $i < @filelist && $i < 255; $i++) {
    printf CONFIGFILE ",\n";
    printf CONFIGFILE "                                      'file:$config{'ec_mon_master_rundir'}/daq-data/$filelist[$i]'";
  }
  printf CONFIGFILE ")\n";
} elsif ( @filelist_archived != 0 ) {
  my $i=0;
  printf CONFIGFILE "    fileNames = cms.untracked.vstring(";
  printf CONFIGFILE "'file:$config{'ec_mon_master_rundir'}/daq-data/trash/$filelist_archived[$i]'";
  for ($i=1; $i < @filelist_archived && $i < 255; $i++) {
    printf CONFIGFILE ",\n";
    printf CONFIGFILE "                                      'file:$config{'ec_mon_master_rundir'}/daq-data/trash/$filelist_archived[$i]'";
  }
  printf CONFIGFILE ")\n";
} else {
  exit 1;
}

print CONFIGFILE <<EOF3;
)

process.MessageLogger = cms.Service("MessageLogger",
    cout = cms.untracked.PSet(
        threshold = cms.untracked.string('WARNING'),
        noLineBreaks = cms.untracked.bool(True),
        noTimeStamps = cms.untracked.bool(True),
        default = cms.untracked.PSet(
            limit = cms.untracked.int32(0)
        ),
        EcalRawToDigi = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiTriggerType = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiTpg = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiNumTowerBlocks = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiTowerId = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiTowerSize = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiChId = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiGainZero = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiGainSwitch = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiDccBlockSize = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiMemBlock = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiMemTowerId = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiMemChId = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiMemGain = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiTCC = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalRawToDigiSRP = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalDCCHeaderRuntypeDecoder = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        ),
        EcalPedOffset = cms.untracked.PSet(
            limit = cms.untracked.int32(1000)
        )
    ),
    categories = cms.untracked.vstring('EcalRawToDigi',
                                       'EcalRawToDigiTriggerType',
                                       'EcalRawToDigiTpg',
                                       'EcalRawToDigiNumTowerBlocks',
                                       'EcalRawToDigiTowerId',
                                       'EcalRawToDigiTowerSize',
                                       'EcalRawToDigiChId',
                                       'EcalRawToDigiGainZero',
                                       'EcalRawToDigiGainSwitch',
                                       'EcalRawToDigiDccBlockSize',
                                       'EcalRawToDigiMemBlock',
                                       'EcalRawToDigiMemTowerId',
                                       'EcalRawToDigiMemChId',
                                       'EcalRawToDigiMemGain',
                                       'EcalRawToDigiTCC',
                                       'EcalRawToDigiSRP',
                                       'EcalDCCHeaderRuntypeDecoder',
                                       'EcalPedOffset'),
    destinations = cms.untracked.vstring('cout')
)

process.p = cms.Path(process.ecalEBunpacker*process.ecalPedOffset)
process.q = cms.EndPath(process.printAscii)

process.ecalEBunpacker.silentMode = False

EOF3

close CONFIGFILE;

$task = "export SCRAM_ARCH=$cmssw_arch ; source $cmssw_setup ; cd $cmssw_path ; eval `scramv1 runtime -sh` ; cd $config{'ec_mon_master_rundir'}/dqm-data/tmp/ ; time cmsRun pedestal-offset-$runnum.py";

if ( -e "$config{'ec_mon_master_rundir'}/dqm-data/logs/pedestal-offset-$runnum.log" ) {
  system("rm -f $config{'ec_mon_master_rundir'}/dqm-data/logs/pedestal-offset-$runnum.log >> /dev/null 2>&1");
}

my $status = system("($task) > $config{'ec_mon_master_rundir'}/dqm-data/logs/pedestal-offset-$runnum.log 2>&1");

system("mv -f $config{'ec_mon_master_rundir'}/dqm-data/tmp/pedestal-offset-$runnum.py $config{'ec_mon_master_rundir'}/dqm-data/logs/ >> /dev/null 2>&1");

system("mv -f $config{'ec_mon_master_rundir'}/dqm-data/tmp/pedestal-offset-$runnum\_*.xml $config{'ec_mon_master_rundir'}/dqm-data/xml/ >> /dev/null 2>&1");

system("cp $config{'ec_mon_master_rundir'}/dqm-data/xml/pedestal-offset-$runnum\_*.xml $xml_path/ >> /dev/null 2>&1");

system("mv -f $config{'ec_mon_master_rundir'}/dqm-data/tmp/pedestal-offset-$runnum.root $config{'ec_mon_master_rundir'}/dqm-data/xml/ >> /dev/null 2>&1");

exit $status >> 8;

############################################################################

sub usage {
  print STDERR <<INLINE_LITERAL_TEXT;
usage: ec_mon_cmssw_task_wrapper_pedestal-offset [ --run <run_number> | --file /pathname/filename ]
INLINE_LITERAL_TEXT

  exit;
}
