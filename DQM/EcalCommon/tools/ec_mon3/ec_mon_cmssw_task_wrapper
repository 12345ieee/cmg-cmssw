#!/usr/bin/env perl

use strict "vars";
use vars qw( %opts );
use vars qw( %config );

use Getopt::Long;

Getopt::Long::config('bundling_override');
%opts = ();
GetOptions( \%opts,
                "run|r=s",
                "file|f=s",
                "help|h"
);
usage() if ( $opts{'help'} || $Getopt::Long::error );

my $runnum = $opts{'run'};
my $filnam = $opts{'file'};

usage() if ( ! $runnum && ! $filnam );

use File::Basename;

unshift(@INC, dirname($0));
require "ec_mon_utils.pl";

ec_mon_conf_file();

my ($loc, $num, $lun, $out, $fun, $fil, $ful) = split('\.', $runnum);

my $daqdir = "$config{'ec_mon_master_rundir'}/daq-data";
my $trashdir = "$config{'ec_mon_master_rundir'}/daq-data/trash";

my $command = ec_mon_filelist("$daqdir/", $num, $fun);

my @filelist = split('\n', `$command`);

$command = ec_mon_filelist("$trashdir/", $num, $fun);

my @filelist_archived = split('\n', `$command`);

if ( $runnum ) {
  exit 1 unless ( @filelist != 0 ||
                  @filelist_archived != 0 );
}

if ( $filnam ) {
  if ( -e "$filnam" ) {
    $runnum = basename($filnam);
  } else {
    print "file: $filnam does not exist ...\n";
    exit 1;
  }
}

my $cmsenv;

if ( @filelist != 0 && $filelist[0] =~ /^Minidaq/ ) {
    $cmsenv = "/nfshome0/ecalpro/DQM/swconf/cmsenv.miniDAQ";
}
elsif ( $config{'ec_mon_path'} =~ /localDAQ/ ) {
    $cmsenv = "/nfshome0/ecalpro/DQM/swconf/cmsenv.localDAQ";
}
elsif ( $config{'ec_mon_path'} =~ /globalDAQ/ ) {
    $cmsenv = "/nfshome0/ecalpro/DQM/swconf/cmsenv.globalDAQ";
}
else {
    exit 1;
}

my $globaltag;
open(CMSENV, "<$cmsenv");
while(<CMSENV>){
    my($line) = $_;
    chomp($line);
    if($line =~ /^[ ]*globaltag[=]([A-Z0-9_]+)[ ]*$/) {
	$globaltag = $1;
    }
}
close(CMSENV);

my $task;

my $workdir = "$config{'ec_mon_master_rundir'}/dqm-data/tmp";
my $cfgfile = "$workdir/monitor-$runnum.py";

if ( -e $cfgfile ) {
  system("rm -f $cfgfile >> /dev/null 2>&1");
}

my $environment;
my $cfgtype;

if ( $config{'ec_mon_path'} =~ /localDAQ/ ) {
    $environment = 'LocalDAQ';
    $cfgtype = 'Calibration';
}
elsif ( $config{'ec_mon_path'} =~ /globalDAQ/ ) {
    $environment = 'PrivQuasiLive';
    if ( @filelist != 0 && $filelist[0] =~ /^Minidaq/ ) {
	$cfgtype = 'Calibration';
    }
    else {
	$cfgtype = 'Physics';
    }
}

my $sourceFiles;
if ( $filnam ) {
    $sourceFiles = $filnam;
}
elsif ( @filelist != 0 ) {
    for (my $i = 0; $i < @filelist; $i++) {
	$sourceFiles = "$sourceFiles$daqdir/$filelist[$i] ";
    }
}
elsif ( @filelist_archived != 0 ) {
    for (my $i = 0; $i < @filelist; $i++) {
	$sourceFiles = "$sourceFiles$trashdir/$filelist_archived[$i] ";
    }
}
else {
  exit 1;
}

system("python ~ecalpro/DQM/tools/ecalConfigBuilder.py -e $environment -c $cfgtype -f $cfgfile --source='$sourceFiles' -g '$globaltag'");

$task = "source $cmsenv; cd $workdir ; time cmsRun $cfgfile";

my $logdir = "$config{'ec_mon_master_rundir'}/dqm-data/logs";
my $logfile = "$logdir/$runnum.cmssw.log";

if ( -e $logfile ) {
  system("rm -f $logfile >> /dev/null 2>&1");
}

my $status = system("($task) > $logfile 2>&1");

system("mv -f $cfgfile $logdir/ >> /dev/null 2>&1");

system("mv -f $workdir/DQM_*_R0$num.root $config{'ec_mon_master_rundir'}/dqm-data/root/ >> /dev/null 2>&1");

exit $status >> 8;

############################################################################

sub usage {
  print STDERR <<INLINE_LITERAL_TEXT;
usage: ec_mon_cmssw_task_wrapper [ --run <run_number> | --file /pathname/filename ]
INLINE_LITERAL_TEXT

  exit;
}
