#!/usr/bin/env perl

use strict "vars";
use vars qw( %opts );
use vars qw( %config );

use Getopt::Long;

Getopt::Long::config('bundling_override');
%opts = ();
GetOptions( \%opts,
                "conf|c=s",
                "norun",
                "fix_now",
                "debug|d",
                "help|h"
);
usage() if ( $opts{'help'} || $Getopt::Long::error );

use File::Basename;

unshift(@INC, dirname($0));
require "ec_mon_utils.pl";

ec_mon_conf_file();

#time after which to change a 'daq_run' into 'daq_fail'
my $fix_timeout = 2 * 60 * 60; #2 hours in secs

$fix_timeout = 10 if ( $opts{'fix_now'} );

my @daq_runs;

if ( @ARGV ) {
  @daq_runs = split('\n', `$config{'ec_mon_path'}/ec_mon_check --nocolor --short --daq_run --conf $config{'$ec_mon_conf'} @ARGV`);
} else {
  @daq_runs = split('\n', `$config{'ec_mon_path'}/ec_mon_check --nocolor --short --daq_run --conf $config{'$ec_mon_conf'}`);
}

my $run;

if ( @daq_runs == 0 ) {
  print "No runs to check\n" if ( $opts{'debug'} );
} else {

  foreach $run ( @daq_runs ) {

    $run =~ s/ *$//;
    my ($loc, $num, $lun, $out, $fun, $fil, $ful, $typ) = split('\.', "$run");
    $run = "$loc.$num.$lun.$out.$fun.$fil.$ful";

    if ( -e "$config{'ec_mon_master_rundir'}/dqm-data/status/.$run.$typ.daq_run" ) {

      my $update = (stat("$config{'ec_mon_master_rundir'}/dqm-data/status/.$run.$typ.daq_run"))[9];
      my $time = ((( time() - $update ) / 60.) / 60.);

      printf "Last updated %.1f hours ago\n", $time if ( $opts{'debug'} );

      if ( ( time() - $update ) > $fix_timeout ) {

        print "Run $run needs to be marked daq_done\n" if ( $opts{'debug'} );

        system("$config{'ec_mon_path'}/ec_mon_check --conf $config{'$ec_mon_conf'} --set_status daq_done $run >> /dev/null 2>&1") unless ( $opts{'norun'} );

      }

    }

  }

}

exit 0;

############################################################################

sub usage {

  print STDERR <<INLINE_LITERAL_TEXT;
usage: ec_mon_daq_watcher

  --conf   Needs a path name to use a ec_mon.conf from a location other
           than the current directory.

  --norun

  --fix_now

  --debug
INLINE_LITERAL_TEXT

  exit;
}

############################################################################
